

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>cutevariant.core.sql &mdash; Cutevariant  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="Cutevariant  documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Cutevariant
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html#development">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../command_line_usage.html">Command line usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev_documentation.html">Documentation for developers</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Cutevariant</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>cutevariant.core.sql</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for cutevariant.core.sql</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module to bring together all the SQL related functions</span>

<span class="sd">To read and write the sqlite database with the schema described here.</span>
<span class="sd">Each method refers to a CRUD operation using following prefixes:</span>
<span class="sd">``get_``, ``insert_``, ``update_``, ``remove_`` and takes a sqlite connection</span>
<span class="sd">as ``conn`` attribute.</span>

<span class="sd">The module contains also QueryBuilder class to build complexe variant query based</span>
<span class="sd">on filters, columns and selections.</span>

<span class="sd">Example::</span>

<span class="sd">    # Read sample table information</span>
<span class="sd">    from cutevariant.core import sql</span>
<span class="sd">    conn = sql.get_sql_connection(&quot;project.db&quot;)</span>
<span class="sd">    sql.get_samples(conn)</span>

<span class="sd">    # Build a variant query</span>
<span class="sd">    from cutevariant.core import sql</span>
<span class="sd">    conn = sql.get_sql_connection(&quot;project.db&quot;)</span>
<span class="sd">    builder = QueryBuilder(conn)</span>
<span class="sd">    builder.columns = [&quot;chr&quot;,&quot;pos&quot;,&quot;ref&quot;,&quot;alt&quot;]</span>
<span class="sd">    print(builder.sql())</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Standard imports</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="k">import</span> <span class="n">parse_version</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">lru_cache</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>


<span class="c1"># Custom imports</span>
<span class="kn">import</span> <span class="nn">cutevariant.commons</span> <span class="k">as</span> <span class="nn">cm</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">logger</span><span class="p">()</span>


<span class="c1">## Misc functions ==============================================================</span>


<div class="viewcode-block" id="get_sql_connection"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_sql_connection">[docs]</a><span class="k">def</span> <span class="nf">get_sql_connection</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Open a SQLite database and return the connection object</span>

<span class="sd">    Args:</span>
<span class="sd">        filepath (str): sqlite filepath</span>

<span class="sd">    Returns:</span>
<span class="sd">        sqlite3.Connection: Sqlite3 Connection</span>
<span class="sd">            The connection is initialized with `row_factory = Row`.</span>
<span class="sd">            So all results are accessible via indexes or keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="c1"># Activate Foreign keys</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys = ON&quot;</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
    <span class="n">foreign_keys_status</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;get_sql_connection:: foreign_keys state: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">foreign_keys_status</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">foreign_keys_status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Foreign keys can&#39;t be activated :(&quot;</span>

    <span class="c1"># Create function for SQLite</span>
    <span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="c1"># Need to cast item to str... costly</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="n">connection</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s2">&quot;REGEXP&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">regexp</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">LOGGER</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="c1"># Enable tracebacks from custom functions in DEBUG mode only</span>
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">enable_callback_tracebacks</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">connection</span></div>


<div class="viewcode-block" id="drop_table"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.drop_table">[docs]</a><span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Drop the given table</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.connection): Sqlite3 connection</span>
<span class="sd">        table_name (str): sqlite table name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;DROP TABLE IF EXISTS </span><span class="si">{table_name}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="clear_table"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.clear_table">[docs]</a><span class="k">def</span> <span class="nf">clear_table</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clear content of the given table</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.Connection): Sqlite3 Connection</span>
<span class="sd">        table_name (str): sqlite table name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;DELETE  FROM </span><span class="si">{table_name}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_table_columns"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_table_columns">[docs]</a><span class="k">def</span> <span class="nf">get_table_columns</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the list of columns for the given table</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.Connection): Sqlite3 Connection</span>
<span class="sd">        table_name (str): sqlite table name</span>

<span class="sd">    Returns:</span>
<span class="sd">        Columns description from table_info</span>
<span class="sd">        ((0, &#39;chr&#39;, &#39;str&#39;, 0, None, 1 ... ))</span>

<span class="sd">    References:</span>
<span class="sd">        used by async_insert_many_variants() to build queries with placeholders</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;pragma table_info(</span><span class="si">{table_name}</span><span class="s2">)&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;id&quot;</span>
    <span class="p">]</span></div>


<div class="viewcode-block" id="create_indexes"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_indexes">[docs]</a><span class="k">def</span> <span class="nf">create_indexes</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create extra indexes on tables</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.Connection): Sqlite3 Connection</span>

<span class="sd">    Note:</span>
<span class="sd">        This function must be called after batch insertions.</span>
<span class="sd">        You should use this function instead of individual functions.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">create_variants_indexes</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">create_selections_indexes</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Some databases have not annotations table</span>
        <span class="n">create_annotations_indexes</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;create_indexes:: sqlite3.</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="count_query"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.count_query">[docs]</a><span class="k">def</span> <span class="nf">count_query</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Count elements from the given query or table</span>

<span class="sd">    Notes about memoization here:</span>
<span class="sd">        Not implemented here, we should be able to clear cache when</span>
<span class="sd">        the current project is changed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;SELECT COUNT(*) as count FROM (</span><span class="si">{query}</span><span class="s2">)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span></div>


<span class="c1">## project table ===============================================================</span>


<div class="viewcode-block" id="create_project"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_project">[docs]</a><span class="k">def</span> <span class="nf">create_project</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reference</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create the table &quot;projects&quot; and insert project name and reference genome</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.Connection): Sqlite3 Connection</span>
<span class="sd">        name (str): Project name</span>
<span class="sd">        reference (str): Genom project</span>

<span class="sd">    Todo:</span>
<span class="sd">        * Rename to create_table_project</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;CREATE TABLE projects (id INTEGER PRIMARY KEY, name TEXT, reference TEXT)&quot;</span>
    <span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;INSERT INTO projects (name, reference) VALUES (?, ?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<span class="c1">## metadatas table =============================================================</span>


<div class="viewcode-block" id="create_table_metadatas"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_table_metadatas">[docs]</a><span class="k">def</span> <span class="nf">create_table_metadatas</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create table metdata</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.Connection): Sqlite3 Connection</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;CREATE TABLE metadatas (id INTEGER PRIMARY KEY, key TEXT, value TEXT)&quot;</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="insert_many_metadatas"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.insert_many_metadatas">[docs]</a><span class="k">def</span> <span class="nf">insert_many_metadatas</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">metadatas</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;Insert metadata</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.Connection): Sqlite3 Connection</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">metadatas</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
            <span class="s2">&quot;INSERT INTO metadatas (key,value) VALUES (?,?)&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">metadatas</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_metadatas"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_metadatas">[docs]</a><span class="k">def</span> <span class="nf">get_metadatas</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a dictionary of metadatas</span>

<span class="sd">    Returns:</span>
<span class="sd">        [dict]: matadata fieldname as keys</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
    <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT key, value FROM metadatas&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">g</span><span class="p">}</span></div>


<span class="c1">## selections &amp; sets tables ====================================================</span>


<div class="viewcode-block" id="delete_by_name"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.delete_by_name">[docs]</a><span class="k">def</span> <span class="nf">delete_by_name</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete data in &quot;selections&quot; or &quot;sets&quot; tables with the given name</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlit3.Connection): sqlite3 connection</span>
<span class="sd">        name (str): Selection/set name</span>
<span class="sd">        table_name (str): Name of the table concerned by the deletion</span>
<span class="sd">    Returns:</span>
<span class="sd">        int: Number of rows affected</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">table_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please specify a table name&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">table_name</span> <span class="o">==</span> <span class="s2">&quot;selections&quot;</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;variants&quot;</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot remove the default selection &#39;variants&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;DELETE FROM `</span><span class="si">{table_name}</span><span class="s2">` WHERE name = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span></div>


<span class="c1">## selection table =============================================================</span>


<div class="viewcode-block" id="create_table_selections"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_table_selections">[docs]</a><span class="k">def</span> <span class="nf">create_table_selections</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create the table &quot;selections&quot; and association table &quot;selection_has_variant&quot;</span>

<span class="sd">    This table stores variants selection saved by the user:</span>

<span class="sd">        - name: name of the set of variants</span>
<span class="sd">        - count: number of variants concerned by this set</span>
<span class="sd">        - query: the SQL query which generated the set</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.Connection): Sqlite3 Connection</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="c1"># selection_id is an alias on internal autoincremented &#39;rowid&#39;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;CREATE TABLE selections (</span>
<span class="sd">        id INTEGER PRIMARY KEY ASC,</span>
<span class="sd">        name TEXT, count INTEGER, query TEXT</span>
<span class="sd">        )&quot;&quot;&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Association table: do not use useless rowid column</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;CREATE TABLE selection_has_variant (</span>
<span class="sd">        variant_id INTEGER NOT NULL,</span>
<span class="sd">        selection_id INTEGER NOT NULL,</span>
<span class="sd">        PRIMARY KEY (variant_id, selection_id),</span>
<span class="sd">        FOREIGN KEY (selection_id) REFERENCES selections (id)</span>
<span class="sd">          ON DELETE CASCADE</span>
<span class="sd">          ON UPDATE NO ACTION</span>
<span class="sd">        ) WITHOUT ROWID&quot;&quot;&quot;</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_selections_indexes"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_selections_indexes">[docs]</a><span class="k">def</span> <span class="nf">create_selections_indexes</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create indexes on the &quot;selections&quot; table</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.Connection): Sqlite3 Connection</span>

<span class="sd">    Note:</span>
<span class="sd">        * This function should be called after batch insertions.</span>
<span class="sd">        * This function ensures the unicity of selections names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE UNIQUE INDEX idx_selections ON selections (name)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_selection_has_variant_indexes"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_selection_has_variant_indexes">[docs]</a><span class="k">def</span> <span class="nf">create_selection_has_variant_indexes</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create indexes on &quot;selection_has_variant&quot; table</span>

<span class="sd">    For joins between selections and variants tables</span>

<span class="sd">    Reference:</span>
<span class="sd">        * create_selections_indexes()</span>
<span class="sd">        * insert_selection()</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.Connection/sqlite3.Cursor): Sqlite3 connection</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;CREATE INDEX idx_selection_has_variant ON selection_has_variant (selection_id)&quot;</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="insert_selection"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.insert_selection">[docs]</a><span class="k">def</span> <span class="nf">insert_selection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;no_name&quot;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Insert one selection record</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.Connection/sqlite3.Cursor): Sqlite3 Connection.</span>
<span class="sd">        It can be a cursor or a connection here...</span>
<span class="sd">        query (str): a VQL query</span>
<span class="sd">        name (str, optional): Name of selection</span>
<span class="sd">        count (int, optional): Variant count of selection</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: Return last rowid</span>

<span class="sd">    See Also:</span>
<span class="sd">        create_selection_from_sql()</span>

<span class="sd">    Warning:</span>
<span class="sd">        This function does a commit !</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">)</span> <span class="k">else</span> <span class="n">conn</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;INSERT INTO selections (name, count, query) VALUES (?,?,?)&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">query</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
        <span class="c1"># Commit only if connection is given. =&gt; avoid not consistent DB</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span></div>


<span class="c1"># Delete selections by name</span>
<span class="n">delete_selection_by_name</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">delete_by_name</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;selections&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="create_selection_from_sql"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_selection_from_sql">[docs]</a><span class="k">def</span> <span class="nf">create_selection_from_sql</span><span class="p">(</span>
    <span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_selection</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a selection record from sql variant query</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.connection): Sqlite3 connection</span>
<span class="sd">        query (str): SQL query that select all variant ids. See `from_selection`</span>
<span class="sd">        name (str): Name of selection</span>
<span class="sd">        count (int/None, optional): Variant count</span>
<span class="sd">        from_selection (bool, optional): Use a different</span>
<span class="sd">            field name for variants ids; `variant_id` if `from_selection` is `True`,</span>
<span class="sd">            just `id` if `False`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        selection_id, if lines have been inserted; None otherwise (rollback).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Compute query count</span>
    <span class="c1"># TODO : this can take a while .... need to compute only one from elsewhere</span>
    <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">count_query</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

    <span class="c1"># Create selection</span>
    <span class="n">selection_id</span> <span class="o">=</span> <span class="n">insert_selection</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>

    <span class="c1"># DROP indexes</span>
    <span class="c1"># For joins between selections and variants tables</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;DROP INDEX idx_selection_has_variant&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Insert into selection_has_variant table</span>
    <span class="c1"># PS: We use DISTINCT keyword to statisfy the unicity constraint on</span>
    <span class="c1"># (variant_id, selection_id) of &quot;selection_has_variant&quot; table.</span>
    <span class="c1"># TODO: is DISTINCT useful here? How a variant could be associated several</span>
    <span class="c1"># times with an association?</span>
    <span class="k">if</span> <span class="n">from_selection</span><span class="p">:</span>
        <span class="c1"># Optimized only for the creation of a selection from set operations</span>
        <span class="c1"># variant_id is the only useful column here</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO selection_has_variant</span>
<span class="s2">        SELECT DISTINCT variant_id, </span><span class="si">{selection_id}</span><span class="s2"> FROM (</span><span class="si">{query}</span><span class="s2">)</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback</span>
        <span class="c1"># Used when creating a selection from a VQL query in the UI</span>
        <span class="c1"># Default behavior =&gt; a variant is based on chr,pos,ref,alt</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO selection_has_variant</span>
<span class="s2">        SELECT DISTINCT id, </span><span class="si">{selection_id}</span><span class="s2"> FROM (</span><span class="si">{query}</span><span class="s2">)</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">affected_rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>

    <span class="c1"># REBUILD INDEXES</span>
    <span class="c1"># For joints between selections and variants tables</span>
    <span class="n">create_selection_has_variant_indexes</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">affected_rows</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">selection_id</span>
    <span class="c1"># Must alert a user because no selection is created here</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="create_selection_from_bed"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_selection_from_bed">[docs]</a><span class="k">def</span> <span class="nf">create_selection_from_bed</span><span class="p">(</span>
    <span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bed_intervals</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a new selection based on the given intervals taken from a BED file</span>

<span class="sd">    Variants whose positions are contained in the intervals specified by the</span>
<span class="sd">    BED file will be referenced into the table selection_has_variant under</span>
<span class="sd">    a new selection.</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.connection): Sqlite3 connection</span>
<span class="sd">        source (str): Selection name (source); Ex: &quot;variants&quot; (default)</span>
<span class="sd">        target (str): Selection name (target)</span>
<span class="sd">        bed_intervals (list/generator [dict]): List of intervals</span>
<span class="sd">            Each interval is a dict with the expected keys: (chrom, start, end, name)</span>

<span class="sd">    Returns:</span>
<span class="sd">        lastrowid, if lines have been inserted; None otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Create temporary table</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF exists bed_table&quot;</span><span class="p">)</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;CREATE TABLE bed_table (</span>
<span class="sd">        id INTEGER PRIMARY KEY ASC,</span>
<span class="sd">        bin INTEGER DEFAULT 0,</span>
<span class="sd">        chr TEXT,</span>
<span class="sd">        start INTEGER,</span>
<span class="sd">        end INTEGER,</span>
<span class="sd">        name INTEGER)&quot;&quot;&quot;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">bed_intervals</span><span class="p">:</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;INSERT INTO bed_table (bin, chr, start, end, name) VALUES (?,?,?,?,?)&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">interval</span><span class="p">[</span><span class="s2">&quot;chrom&quot;</span><span class="p">],</span>
                <span class="n">interval</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span>
                <span class="n">interval</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">],</span>
                <span class="n">interval</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;variants&quot;</span><span class="p">:</span>
        <span class="n">source_query</span> <span class="o">=</span> <span class="s2">&quot;SELECT variants.id AS variant_id FROM variants&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">source_query</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT variants.id AS variant_id FROM variants</span>
<span class="s2">        INNER JOIN selections ON selections.name = &#39;</span><span class="si">{source}</span><span class="s2">&#39;</span>
<span class="s2">        INNER JOIN selection_has_variant AS sv ON sv.selection_id = selections.id AND sv.variant_id = variants.id </span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">source_query</span>
        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INNER JOIN bed_table ON</span>
<span class="s2">        variants.chr = bed_table.chr AND</span>
<span class="s2">        variants.pos &gt;= bed_table.start AND</span>
<span class="s2">        variants.pos &lt;= bed_table.end&quot;&quot;&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">create_selection_from_sql</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">from_selection</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_selections"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_selections">[docs]</a><span class="k">def</span> <span class="nf">get_selections</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get selections in &quot;selections&quot; table</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.connection): Sqlite3 connection</span>

<span class="sd">    Yield:</span>
<span class="sd">        Dictionnaries with as many keys as there are columnsin the table.</span>

<span class="sd">    Example::</span>
<span class="sd">        {&quot;id&quot;: ..., &quot;name&quot;: ..., &quot;count&quot;: ..., &quot;query&quot;: ...}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM selections&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="delete_selection"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.delete_selection">[docs]</a><span class="k">def</span> <span class="nf">delete_selection</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">selection_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete the selection with the given id in the &quot;selections&quot; table</span>

<span class="sd">    :return: Number of rows deleted</span>
<span class="sd">    :rtype: &lt;int&gt;</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.Connection): Sqlite connection</span>
<span class="sd">        selection_id (int): id from selection table</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: Number of rows affected</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM selections WHERE rowid = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">selection_id</span><span class="p">,))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span></div>


<div class="viewcode-block" id="edit_selection"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.edit_selection">[docs]</a><span class="k">def</span> <span class="nf">edit_selection</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">selection</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the name and count of a selection with the given id</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.Connection): sqlite3 Connection</span>
<span class="sd">        selection (dict): key/value data</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: last rowid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;UPDATE selections SET name=:name, count=:count WHERE id = :id&quot;</span><span class="p">,</span> <span class="n">selection</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span></div>


<span class="c1">## wordsets table ===============================================================</span>


<div class="viewcode-block" id="create_table_wordsets"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_table_wordsets">[docs]</a><span class="k">def</span> <span class="nf">create_table_wordsets</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create the table &quot;sets&quot;</span>

<span class="sd">    This table stores variants selection saved by the user:</span>
<span class="sd">        - name: name of the set of variants</span>
<span class="sd">        - value: number of variants concerned by this set</span>

<span class="sd">    TODO: Denormalization of this table **WILL** BE a problem in the future...</span>
<span class="sd">        But i&#39;m fed up of these practices.</span>

<span class="sd">    TODO: for now the one to many relation is not implemented</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.Connection): Sqlite3 Connection</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;CREATE TABLE wordsets (</span>
<span class="sd">        id INTEGER PRIMARY KEY ASC,</span>
<span class="sd">        name TEXT,</span>
<span class="sd">        value TEXT,</span>
<span class="sd">        UNIQUE (name, value)</span>
<span class="sd">        )&quot;&quot;&quot;</span>
    <span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="sanitize_words"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.sanitize_words">[docs]</a><span class="k">def</span> <span class="nf">sanitize_words</span><span class="p">(</span><span class="n">words</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a set of cleaned words</span>

<span class="sd">    See Also:</span>
<span class="sd">        - :meth:`import_wordset_from_file`</span>
<span class="sd">        - :meth:`cutevariant.gui.plugins.word_set.widgets.WordListDialog.load_file`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Search whitespaces</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;[ </span><span class="se">\t\n\r\f\v</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="n">striped_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">striped_line</span> <span class="ow">or</span> <span class="n">expr</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">striped_line</span><span class="p">):</span>
            <span class="c1"># Skip lines with whitespaces</span>
            <span class="k">continue</span>
        <span class="n">data</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">striped_line</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="import_wordset_from_file"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.import_wordset_from_file">[docs]</a><span class="k">def</span> <span class="nf">import_wordset_from_file</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">wordset_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Create Word set from the given file</span>

<span class="sd">    Args:</span>
<span class="sd">        wordset_name: Name of the Word set</span>
<span class="sd">        filename: File to be imported, we expect 1 word per line.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Number of rows affected during insertion (number of words inserted).</span>
<span class="sd">        None if 0 word can be inserted.</span>

<span class="sd">    Current data filtering (same as in the word_set plugin):</span>
<span class="sd">        - Strip trailing spaces and EOL characters</span>
<span class="sd">        - Skip empty lines</span>
<span class="sd">        - Skip lines with whitespaces characters (``[ \t\n\r\f\v]``)</span>

<span class="sd">    Examples:</span>
<span class="sd">        - The following line will be skipped:</span>
<span class="sd">          ``&quot;abc  def\tghi\t  \r\n&quot;``</span>
<span class="sd">        - The following line will be cleaned:</span>
<span class="sd">          ``&quot;abc\r\n&quot;``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Search whitespaces</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_h</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sanitize_words</span><span class="p">(</span><span class="n">f_h</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Insertion</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
        <span class="s2">&quot;INSERT INTO wordsets (name, value) VALUES (?,?)&quot;</span><span class="p">,</span>
        <span class="n">it</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(),</span> <span class="n">data</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="n">wordset_name</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span></div>


<span class="c1"># Delete set by name</span>
<span class="n">delete_set_by_name</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">delete_by_name</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;wordsets&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="get_wordsets"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_wordsets">[docs]</a><span class="k">def</span> <span class="nf">get_wordsets</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the number of words per word set stored in DB</span>

<span class="sd">    Returns:</span>
<span class="sd">        generator[dict]: Yield dictionaries with `name` and `count` keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;SELECT name, COUNT(*) as &#39;count&#39; FROM wordsets GROUP BY name&quot;</span>
    <span class="p">):</span>
        <span class="k">yield</span> <span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_words_in_set"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_words_in_set">[docs]</a><span class="k">def</span> <span class="nf">get_words_in_set</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">wordset_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return generator of words in the given word set</span>

<span class="sd">    Returns:</span>
<span class="sd">        generator[str]: Yield words of the word set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;SELECT DISTINCT value FROM wordsets WHERE name = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">wordset_name</span><span class="p">,)</span>
    <span class="p">):</span>
        <span class="k">yield</span> <span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span></div>


<span class="c1">## Operations on sets of variants ==============================================</span>


<div class="viewcode-block" id="get_query_columns"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_query_columns">[docs]</a><span class="k">def</span> <span class="nf">get_query_columns</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;variant&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;(DEPRECATED FOR NOW, NOT USED)</span>

<span class="sd">    Handy func to get columns to be queried according to the group by argument</span>

<span class="sd">    .. note:: Used by intersect_variants, union_variants, subtract_variants</span>
<span class="sd">        in order to avoid code duplication.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;site&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;chr,pos&quot;</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;variant&quot;</span><span class="p">:</span>
        <span class="c1"># Not used</span>
        <span class="k">return</span> <span class="s2">&quot;variant_id&quot;</span>

    <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="intersect_variants"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.intersect_variants">[docs]</a><span class="k">def</span> <span class="nf">intersect_variants</span><span class="p">(</span><span class="n">query1</span><span class="p">,</span> <span class="n">query2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the variants obtained by the intersection of 2 queries</span>

<span class="sd">    Try to handle precedence of operators.</span>
<span class="sd">    - The precedence of UNION and EXCEPT are similar, they are processed from</span>
<span class="sd">    left to right.</span>
<span class="sd">    - Both of the operations are fulfilled before INTERSECT operation,</span>
<span class="sd">    i.e. they have precedence over it.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;SELECT * FROM (</span><span class="si">{query1}</span><span class="s2"> INTERSECT </span><span class="si">{query2}</span><span class="s2">)&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="union_variants"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.union_variants">[docs]</a><span class="k">def</span> <span class="nf">union_variants</span><span class="p">(</span><span class="n">query1</span><span class="p">,</span> <span class="n">query2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the variants obtained by the union of 2 queries&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{query1}</span><span class="s2"> UNION </span><span class="si">{query2}</span><span class="s2">&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="subtract_variants"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.subtract_variants">[docs]</a><span class="k">def</span> <span class="nf">subtract_variants</span><span class="p">(</span><span class="n">query1</span><span class="p">,</span> <span class="n">query2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the variants obtained by the difference of 2 queries&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{query1}</span><span class="s2"> EXCEPT </span><span class="si">{query2}</span><span class="s2">&quot;&quot;&quot;</span></div>


<span class="c1">## fields table ================================================================</span>


<div class="viewcode-block" id="create_table_fields"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_table_fields">[docs]</a><span class="k">def</span> <span class="nf">create_table_fields</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create the table &quot;fields&quot;</span>

<span class="sd">    This table contain fields. A field is a column with its description and type;</span>
<span class="sd">    it can be choose by a user to build a Query</span>
<span class="sd">    Fields are the columns of the tables: variants, annotations and sample_has_variant.</span>
<span class="sd">    Fields are extracted from reader objects and are dynamically constructed.</span>

<span class="sd">    variants:</span>
<span class="sd">    Chr,pos,ref,alt, filter, qual, dp, af, etc.</span>

<span class="sd">    annotations:</span>
<span class="sd">    Gene, transcrit, etc.</span>

<span class="sd">    sample_has_variant:</span>
<span class="sd">    Genotype</span>

<span class="sd">    :param conn: sqlite3.connect</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;CREATE TABLE fields</span>
<span class="sd">        (id INTEGER PRIMARY KEY, name TEXT, category TEXT, type TEXT, description TEXT)</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="insert_field"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.insert_field">[docs]</a><span class="k">def</span> <span class="nf">insert_field</span><span class="p">(</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;no_name&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s2">&quot;variants&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="nb">str</span><span class="p">()</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Insert one field record (NOT USED)</span>

<span class="sd">    :param conn: sqlite3.connect</span>
<span class="sd">    :key name: field name</span>
<span class="sd">    :key category: category field name.</span>
<span class="sd">        .. warning:: The default is &quot;variants&quot;. Don&#39;t use sample as category name</span>
<span class="sd">    :key type: sqlite type which can be: INTEGER, REAL, TEXT</span>
<span class="sd">        .. todo:: Check this argument...</span>
<span class="sd">    :key description: Text that describes the field (showed to the user).</span>
<span class="sd">    :return: Last row id</span>
<span class="sd">    :rtype: &lt;int&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;INSERT INTO fields VALUES (?, ?, ?, ?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span></div>


<div class="viewcode-block" id="insert_many_fields"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.insert_many_fields">[docs]</a><span class="k">def</span> <span class="nf">insert_many_fields</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Insert multiple fields into &quot;fields&quot; table using one commit</span>

<span class="sd">    :param conn: sqlite3.connect</span>
<span class="sd">    :param data: list of field dictionnary</span>

<span class="sd">    :Examples:</span>

<span class="sd">        insert_many_fields(conn, [{name:&quot;sacha&quot;, category:&quot;variant&quot;, count: 0, description=&quot;a description&quot;}])</span>
<span class="sd">        insert_many_fields(conn, reader.get_fields())</span>

<span class="sd">    .. seealso:: insert_field, abstractreader</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        INSERT INTO fields (name,category,type,description)</span>
<span class="sd">        VALUES (:name,:category,:type,:description)</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_fields"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_fields">[docs]</a><span class="nd">@lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_fields</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get fields as list of dictionnary</span>

<span class="sd">    .. seealso:: insert_many_fields</span>

<span class="sd">    :param conn: sqlite3.connect</span>
<span class="sd">    :return: Tuple of dictionnaries with as many keys as there are columns</span>
<span class="sd">        in the table.</span>
<span class="sd">    :rtype: &lt;tuple &lt;dict&gt;&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM fields&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_field_by_category"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_field_by_category">[docs]</a><span class="nd">@lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_field_by_category</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get fields within a category</span>

<span class="sd">    :param conn: sqlite3.connect</span>
<span class="sd">    :param category: Category of field requested.</span>
<span class="sd">    :type category: &lt;str&gt;</span>
<span class="sd">    :return: Tuple of dictionnaries with as many keys as there are columns</span>
<span class="sd">        in the table. Dictionnaries are only related to the given field category.</span>
<span class="sd">    :rtype: &lt;tuple &lt;dict&gt;&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">get_fields</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">category</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_field_by_name"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_field_by_name">[docs]</a><span class="k">def</span> <span class="nf">get_field_by_name</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return field by its name</span>

<span class="sd">    .. seealso:: get_fields</span>

<span class="sd">    :param conn: sqlite3.connect</span>
<span class="sd">    :param field_name: field name</span>
<span class="sd">    :return: field record or None if not found.</span>
<span class="sd">    :rtype: &lt;dict&gt; or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
    <span class="n">field_data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;SELECT * FROM fields WHERE name = ? &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">field_name</span><span class="p">,)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">field_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">field_data</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="get_field_range"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_field_range">[docs]</a><span class="k">def</span> <span class="nf">get_field_range</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sample_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return (min,max) of field_name records</span>

<span class="sd">    :param conn: sqlite3.connect</span>
<span class="sd">    :param field_name: field name</span>
<span class="sd">    :param sample_name: sample name. mandatory for fields in the &quot;samples&quot; categories</span>
<span class="sd">    :return: (min, max) or None if the field can&#39;t be processed with mix/max functions.</span>
<span class="sd">    :rtype: tuple or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">get_field_by_name</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span>  <span class="c1"># variants, or annotations or samples</span>
    <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="s2">&quot;samples&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sample_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Pass sample parameter for sample fields&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;SELECT min(</span><span class="si">{field_name}</span><span class="s2">), max(</span><span class="si">{field_name}</span><span class="s2">)</span>
<span class="s2">        FROM sample_has_variant</span>
<span class="s2">        JOIN samples ON sample_has_variant.sample_id = samples.id</span>
<span class="s2">        WHERE samples.name=&#39;</span><span class="si">{sample_name}</span><span class="s2">&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;SELECT min(</span><span class="si">{field_name}</span><span class="s2">), max(</span><span class="si">{field_name}</span><span class="s2">) FROM </span><span class="si">{table}</span><span class="s2">&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">in</span> <span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="get_field_unique_values"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_field_unique_values">[docs]</a><span class="k">def</span> <span class="nf">get_field_unique_values</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sample_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return unique record values for a field name</span>

<span class="sd">    :param conn: sqlite3.connect</span>
<span class="sd">    :param field_name: Name of the field in DB.</span>
<span class="sd">    :param sample_name: sample name. Mandatory for fields in the &quot;samples&quot; categories</span>
<span class="sd">    :return: list of unique values (can be empty if the field is not found)</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">get_field_by_name</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span>  <span class="c1"># variants, or annotations or samples</span>
    <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="s2">&quot;samples&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sample_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Pass sample parameter for sample fields&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;SELECT DISTINCT </span><span class="si">{field_name}</span><span class="s2"></span>
<span class="s2">        FROM sample_has_variant</span>
<span class="s2">        JOIN samples ON sample_has_variant.sample_id = samples.id</span>
<span class="s2">        WHERE samples.name=&#39;</span><span class="si">{sample_name}</span><span class="s2">&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;SELECT DISTINCT `</span><span class="si">{field_name}</span><span class="s2">` FROM </span><span class="si">{table}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span></div>


<span class="c1">## annotations table ===========================================================</span>


<div class="viewcode-block" id="create_table_annotations"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_table_annotations">[docs]</a><span class="k">def</span> <span class="nf">create_table_annotations</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create &quot;annotations&quot; table which contains dynamics fields</span>

<span class="sd">    :param fields: Generator of SQL fields. Example of fields:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            (&#39;allele str NULL&#39;, &#39;consequence str NULL&#39;, ...)</span>
<span class="sd">    :type fields: &lt;generator&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span><span class="s1">&#39;`</span><span class="si">{field[&quot;name&quot;]}</span><span class="s1">` </span><span class="si">{field[&quot;type&quot;]}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">schema</span><span class="p">:</span>
        <span class="c1"># Create minimum annotation table... Can be use later for dynamic annotation.</span>
        <span class="c1"># TODO : we may want to fix annotation fields .</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="s2">&quot;gene TEXT, transcript TEXT&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;create_table_annotations:: No annotation fields detected! =&gt; Fallback&quot;</span>
        <span class="p">)</span>
        <span class="c1"># return</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="c1"># TODO: no primary key/unique index for this table?</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;CREATE TABLE annotations (variant_id INTEGER NOT NULL, </span><span class="si">{schema}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_annotations_indexes"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_annotations_indexes">[docs]</a><span class="k">def</span> <span class="nf">create_annotations_indexes</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create indexes on the &quot;annotations&quot; table</span>

<span class="sd">    .. warning: This function must be called after batch insertions.</span>

<span class="sd">    :Example:</span>

<span class="sd">    .. code-block:: sql</span>

<span class="sd">        SELECT *, group_concat(annotations.rowid) FROM variants</span>
<span class="sd">        LEFT JOIN annotations ON variants.rowid = annotations.variant_id</span>
<span class="sd">        WHERE pos = 0</span>
<span class="sd">        GROUP BY chr,pos</span>
<span class="sd">        LIMIT 100</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Allow search on variant_id</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX idx_annotations ON annotations (variant_id)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_annotations"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_annotations">[docs]</a><span class="k">def</span> <span class="nf">get_annotations</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">variant_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get variant annotation for the variant with the given id&quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
    <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">f</span><span class="s2">&quot;SELECT * FROM annotations WHERE variant_id = </span><span class="si">{variant_id}</span><span class="s2">&quot;</span>
    <span class="p">):</span>
        <span class="k">yield</span> <span class="nb">dict</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span></div>


<span class="c1">## variants table ==============================================================</span>


<div class="viewcode-block" id="create_table_variants"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_table_variants">[docs]</a><span class="k">def</span> <span class="nf">create_table_variants</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create &quot;variants&quot; and &quot;sample_has_variant&quot; tables which contains dynamics fields</span>

<span class="sd">    :Example:</span>

<span class="sd">        fields = get_fields()</span>
<span class="sd">        create_table_variants(conn, fields)</span>

<span class="sd">    .. seealso:: get_fields</span>

<span class="sd">    .. note:: &quot;gt&quot; field in &quot;sample_has_variant&quot; = Patient&#39;s genotype.</span>
<span class="sd">        - Patient without variant: gt = 0: Wild homozygote</span>
<span class="sd">        - Patient with variant in the heterozygote state: gt = -1: Heterozygote</span>
<span class="sd">        - Patient with variant in the homozygote state: gt = 2: Homozygote</span>

<span class="sd">        :Example of VQL query:</span>
<span class="sd">            SELECT chr, pos, genotype(&quot;pierre&quot;) FROM variants</span>

<span class="sd">    :param conn: sqlite3.connect</span>
<span class="sd">    :param fields: list of field dictionnary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Primary key MUST NOT have NULL fields !</span>
    <span class="c1"># PRIMARY KEY should always imply NOT NULL.</span>
    <span class="c1"># Unfortunately, due to a bug in some early versions, this is not the case in SQLite.</span>
    <span class="c1"># For the purposes of UNIQUE constraints, NULL values are considered distinct</span>
    <span class="c1"># from all other values, including other NULLs.</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">f</span><span class="s1">&#39;`</span><span class="si">{field[&quot;name&quot;]}</span><span class="s1">` </span><span class="si">{field[&quot;type&quot;]}</span><span class="s1"> {field.get(&quot;constraint&quot;, &quot;&quot;)}&#39;</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span>
            <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;create_table_variants:: schema: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
    <span class="c1"># Unicity constraint or NOT NULL fields (Cf VcfReader, FakeReader, etc.)</span>
    <span class="c1"># NOTE: specify the constraint in CREATE TABLE generates a lighter DB than</span>
    <span class="c1"># a separated index... Don&#39;t know why.</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">f</span><span class="s2">&quot;&quot;&quot;CREATE TABLE variants (id INTEGER PRIMARY KEY, </span><span class="si">{schema}</span><span class="s2">,</span>
<span class="s2">        UNIQUE (chr,pos,ref,alt))&quot;&quot;&quot;</span>
    <span class="p">)</span>
    <span class="c1"># cursor.execute(f&quot;&quot;&quot;CREATE UNIQUE INDEX idx_variants_unicity ON variants (chr,pos,ref,alt)&quot;&quot;&quot;)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_variants_indexes"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_variants_indexes">[docs]</a><span class="k">def</span> <span class="nf">create_variants_indexes</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create indexes on the &quot;variants&quot; table</span>

<span class="sd">    .. warning:: This function must be called after batch insertions.</span>

<span class="sd">    :Example:</span>

<span class="sd">    .. code-block:: sql</span>

<span class="sd">        SELECT *, group_concat(annotations.rowid) FROM variants</span>
<span class="sd">        LEFT JOIN annotations ON variants.rowid = annotations.variant_id</span>
<span class="sd">        WHERE pos = 0</span>
<span class="sd">        GROUP BY chr,pos</span>
<span class="sd">        LIMIT 100</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Complementary index of the primary key (sample_id, variant_id)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;CREATE INDEX idx_sample_has_variant ON sample_has_variant (variant_id)&quot;</span>
    <span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX idx_variants_pos ON variants (pos)&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX idx_variants_ref_alt ON variants (ref, alt)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_one_variant"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_one_variant">[docs]</a><span class="k">def</span> <span class="nf">get_one_variant</span><span class="p">(</span>
    <span class="n">conn</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span>
    <span class="n">variant_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">with_annotations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">with_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get the variant with the given id</span>

<span class="sd">    TODO: with_annotations, with_samples are quite useless and not used for now</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite3.Connection): sqlite3 connection</span>
<span class="sd">        variant_id (int): Database id of the variant</span>
<span class="sd">        with_annotations (bool, optional): Add annotations items. Default is True</span>
<span class="sd">        with_samples (bool, optional): add samples items. Default is True</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A variant item with all fields in &quot;variants&quot; table;</span>
<span class="sd">            \+ all fields of annotations table if `with_annotations` is True;</span>
<span class="sd">            \+ all fields of sample_has_variant associated to all samples if</span>
<span class="sd">            `with_samples` is True.</span>
<span class="sd">            Example:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                {</span>
<span class="sd">                    variant fields as keys...,</span>
<span class="sd">                    &quot;annotations&quot;: dict of annotations fields as keys...,</span>
<span class="sd">                    &quot;samples&quot;: dict of samples fields as keys...,</span>
<span class="sd">                }</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
    <span class="c1"># Cast sqlite3.Row object to dict because later, we use items() method.</span>
    <span class="n">variant</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">f</span><span class="s2">&quot;SELECT * FROM variants WHERE variants.id = </span><span class="si">{variant_id}</span><span class="s2">&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">variant</span><span class="p">[</span><span class="s2">&quot;annotations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">with_annotations</span><span class="p">:</span>
        <span class="n">variant</span><span class="p">[</span><span class="s2">&quot;annotations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span> <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;SELECT * FROM annotations WHERE variant_id = </span><span class="si">{variant_id}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="n">variant</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">with_samples</span><span class="p">:</span>
        <span class="n">variant</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;&quot;&quot;SELECT samples.name, sample_has_variant.* FROM sample_has_variant</span>
<span class="s2">                LEFT JOIN samples on samples.id = sample_has_variant.sample_id</span>
<span class="s2">                WHERE variant_id = </span><span class="si">{variant_id}</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">return</span> <span class="n">variant</span></div>


<div class="viewcode-block" id="update_variant"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.update_variant">[docs]</a><span class="k">def</span> <span class="nf">update_variant</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">variant</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update variant data</span>

<span class="sd">    Used by widgets to save various modifications in a variant.</span>

<span class="sd">    Args:</span>
<span class="sd">        variant (dict): Fields as keys; values as values.</span>
<span class="sd">            &#39;id&#39; key is expected to set the variant.</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError if &#39;id&#39; key is not in the given variant</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variant</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;&#39;id&#39; key is not in the given variant &lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="n">variant</span><span class="p">)</span>

    <span class="n">unzip</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">l</span><span class="p">))</span>

    <span class="c1"># Get fields and values in separated lists</span>
    <span class="n">placeholders</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">unzip</span><span class="p">(</span>
        <span class="p">[(</span><span class="n">f</span><span class="s2">&quot;`</span><span class="si">{key}</span><span class="s2">` = ? &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">variant</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;id&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;UPDATE variants SET &quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">placeholders</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="s2">&quot; WHERE id = </span><span class="si">{variant[&#39;id&#39;]}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="c1"># LOGGER.info(</span>
    <span class="c1">#     &quot;Update variant %s: placeholders: %s; values %s&quot;,</span>
    <span class="c1">#     variant[&quot;id&quot;], placeholders, values</span>
    <span class="c1"># )</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_variants_count"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_variants_count">[docs]</a><span class="k">def</span> <span class="nf">get_variants_count</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the number of variants in the &quot;variants&quot; table&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">count_query</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;variants&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="async_insert_many_variants"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.async_insert_many_variants">[docs]</a><span class="k">def</span> <span class="nf">async_insert_many_variants</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">total_variant_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yield_every</span><span class="o">=</span><span class="mi">3000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Insert many variants from data into variants table</span>

<span class="sd">    :param conn: sqlite3.connect</span>
<span class="sd">    :param data: list of variant dictionnary which contains same number of key than fields numbers.</span>
<span class="sd">    :param total_variant_count: total variant count, to compute progression</span>
<span class="sd">    :return: Yield a tuple with progression and message.</span>
<span class="sd">        Progression is 0 if total_variant_count is not set.</span>
<span class="sd">    :rtype: &lt;generator &lt;tuple &lt;int&gt;, &lt;str&gt;&gt;</span>


<span class="sd">    :Example:</span>

<span class="sd">        insert_many_variant(conn, [{chr:&quot;chr1&quot;, pos:24234, alt:&quot;A&quot;,&quot;ref&quot;:T }])</span>
<span class="sd">        insert_many_variant(conn, reader.get_variants())</span>

<span class="sd">    .. warning:: Using reader, this can take a while</span>
<span class="sd">    .. todo:: with large dataset, need to cache import</span>
<span class="sd">    .. todo:: handle insertion errors...</span>
<span class="sd">    .. seealso:: abstractreader</span>

<span class="sd">    .. warning:: About using INSERT OR IGNORE: They avoid the following errors:</span>

<span class="sd">        - Upon insertion of a duplicate key where the column must contain</span>
<span class="sd">          a PRIMARY KEY or UNIQUE constraint</span>
<span class="sd">        - Upon insertion of NULL value where the column has</span>
<span class="sd">          a NOT NULL constraint.</span>
<span class="sd">          =&gt; This is not recommended</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">build_columns_and_placeholders</span><span class="p">(</span><span class="n">table_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a tuple of columns and &quot;?&quot; placeholders for INSERT queries&quot;&quot;&quot;</span>
        <span class="c1"># Get columns description from the given table</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">get_table_columns</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
        <span class="c1"># Build dynamic insert query</span>
        <span class="c1"># INSERT INTO variant qcol1, qcol2.... VALUES ?, ?</span>
        <span class="n">tb_cols</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span><span class="s2">&quot;`</span><span class="si">{col}</span><span class="s2">`&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">])</span>
        <span class="n">tb_places</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;?&quot;</span> <span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">tb_cols</span><span class="p">,</span> <span class="n">tb_places</span>

    <span class="c1"># TODO: Can we avoid this step ? This function should receive columns names</span>
    <span class="c1"># because all the tables were created before...</span>
    <span class="c1"># Build placeholders</span>
    <span class="n">var_cols</span><span class="p">,</span> <span class="n">var_places</span> <span class="o">=</span> <span class="n">build_columns_and_placeholders</span><span class="p">(</span><span class="s2">&quot;variants&quot;</span><span class="p">)</span>
    <span class="n">ann_cols</span><span class="p">,</span> <span class="n">ann_places</span> <span class="o">=</span> <span class="n">build_columns_and_placeholders</span><span class="p">(</span><span class="s2">&quot;annotations&quot;</span><span class="p">)</span>

    <span class="n">var_columns</span> <span class="o">=</span> <span class="n">get_table_columns</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;variants&quot;</span><span class="p">)</span>
    <span class="n">ann_columns</span> <span class="o">=</span> <span class="n">get_table_columns</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;annotations&quot;</span><span class="p">)</span>
    <span class="n">sample_columns</span> <span class="o">=</span> <span class="n">get_table_columns</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;sample_has_variant&quot;</span><span class="p">)</span>

    <span class="c1"># Get samples with samples names as keys and sqlite rowid as values</span>
    <span class="c1"># =&gt; used as a mapping for samples ids</span>
    <span class="n">samples_id_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name, id FROM samples&quot;</span><span class="p">))</span>

    <span class="c1"># Check SQLite version and build insertion queries for variants</span>
    <span class="c1"># Old version doesn&#39;t support ON CONFLICT ..target.. DO ... statements</span>
    <span class="c1"># to handle violation of unicity constraint.</span>
    <span class="n">old_sqlite_version</span> <span class="o">=</span> <span class="n">parse_version</span><span class="p">(</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">sqlite_version</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">parse_version</span><span class="p">(</span><span class="s2">&quot;3.24.0&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">old_sqlite_version</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;async_insert_many_variants:: Old SQLite version: </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="s2">&quot; - Fallback to ignore errors!&quot;</span><span class="p">,</span>
            <span class="n">sqlite3</span><span class="o">.</span><span class="n">sqlite_version</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># /!\ This syntax is SQLite specific</span>
        <span class="c1"># /!\ We mask all errors here !</span>
        <span class="n">variant_insert_query</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;INSERT OR IGNORE INTO variants (</span><span class="si">{var_cols}</span><span class="s2">)</span>
<span class="s2">                VALUES (</span><span class="si">{var_places}</span><span class="s2">)&quot;&quot;&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Handle conflicts on the primary key</span>
        <span class="n">variant_insert_query</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;INSERT INTO variants (</span><span class="si">{var_cols}</span><span class="s2">)</span>
<span class="s2">                VALUES (</span><span class="si">{var_places}</span><span class="s2">)</span>
<span class="s2">                ON CONFLICT (chr,pos,ref,alt) DO NOTHING&quot;&quot;&quot;</span>

    <span class="c1"># Insertion - Begin transaction</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Loop over variants</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">variant_count</span><span class="p">,</span> <span class="n">variant</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>

        <span class="c1"># Insert current variant</span>
        <span class="c1"># Use default dict to handle missing values</span>
        <span class="c1"># LOGGER.debug(</span>
        <span class="c1">#    &quot;async_insert_many_variants:: QUERY: %s\nVALUES: %s&quot;,</span>
        <span class="c1">#    variant_insert_query,</span>
        <span class="c1">#    variant,</span>
        <span class="c1"># )</span>

        <span class="c1"># Create list of value to insert</span>
        <span class="c1"># [&quot;chr&quot;,234234,&quot;A&quot;,&quot;G&quot;]</span>
        <span class="n">default_values</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">variant</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">default_values</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">var_columns</span><span class="p">]</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">variant_insert_query</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

        <span class="c1"># If the row is not inserted we skip this erroneous variant</span>
        <span class="c1"># and the data that goes with</span>
        <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;async_insert_many_variants:: The following variant &quot;</span>
                <span class="s2">&quot;contains erroneous data; most of the time it is a &quot;</span>
                <span class="s2">&quot;duplication of the primary key: (chr,pos,ref,alt). &quot;</span>
                <span class="s2">&quot;Please check your data; this variant and its attached &quot;</span>
                <span class="s2">&quot;data will not be inserted!</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">variant</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="c1"># Get variant rowid</span>
        <span class="n">variant_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>

        <span class="c1"># If variant has annotation data, insert record into &quot;annotations&quot; table</span>
        <span class="c1"># One-to-many relationships</span>
        <span class="k">if</span> <span class="s2">&quot;annotations&quot;</span> <span class="ow">in</span> <span class="n">variant</span><span class="p">:</span>
            <span class="c1"># print(&quot;VAR annotations:&quot;, variant[&quot;annotations&quot;])</span>

            <span class="c1"># [{&#39;allele&#39;: &#39;T&#39;, &#39;consequence&#39;: &#39;intergenic_region&#39;, &#39;impact&#39;: &#39;MODIFIER&#39;, ...}]</span>
            <span class="c1"># The aim is to execute all insertions through executemany()</span>
            <span class="c1"># We remove the placeholder :variant_id from places,</span>
            <span class="c1"># and fix it&#39;s value.</span>
            <span class="c1"># TODO: handle missing values;</span>
            <span class="c1"># Les dict de variant[&quot;annotations&quot;] contiennent a priori dj</span>
            <span class="c1"># tous les champs requis (mais vides) car certaines annotations</span>
            <span class="c1"># ont des donnes manquantes.</span>
            <span class="c1"># A t&#39;on l&#39;assurance de cela ?</span>
            <span class="c1"># Dans ce cas pourquoi doit-on bricoler le variant lui-meme avec un</span>
            <span class="c1"># defaultdict(str,variant)) ? Les variants n&#39;ont pas leurs champs par def ?</span>

            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">variant</span><span class="p">[</span><span class="s2">&quot;annotations&quot;</span><span class="p">]:</span>
                <span class="n">default_values</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ann</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">default_values</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ann_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                <span class="n">value</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">variant_id</span><span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="n">temp_ann_places</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;?&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ann_columns</span><span class="p">)))</span>

            <span class="n">q</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;INSERT INTO annotations (</span><span class="si">{ann_cols}</span><span class="s2">)</span>
<span class="s2">                VALUES (</span><span class="si">{temp_ann_places}</span><span class="s2">)&quot;&quot;&quot;</span>

            <span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

        <span class="c1"># If variant has sample data, insert record into &quot;sample_has_variant&quot; table</span>
        <span class="c1"># Many-to-many relationships</span>
        <span class="k">if</span> <span class="s2">&quot;samples&quot;</span> <span class="ow">in</span> <span class="n">variant</span><span class="p">:</span>
            <span class="c1"># print(&quot;VAR samples:&quot;, variant[&quot;samples&quot;])</span>
            <span class="c1"># [{&#39;name&#39;: &#39;NORMAL&#39;, &#39;gt&#39;: 1, &#39;AD&#39;: &#39;64,0&#39;, &#39;AF&#39;: 0.0, ...}]</span>
            <span class="c1"># Insertion only if the current sample name is in samples_names</span>
            <span class="c1"># (authorized sample names already in the database)</span>
            <span class="c1">#</span>
            <span class="c1"># Is this test usefull since samples that are in the database</span>
            <span class="c1"># have been inserted from the same source file (or it is not the case ?) ?</span>
            <span class="c1"># =&gt; yes, we can use external ped file</span>
            <span class="c1"># Retrieve the id of the sample to build the association in</span>
            <span class="c1"># &quot;sample_has_variant&quot; table carrying the data &quot;gt&quot; (genotype)</span>

            <span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">variant</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">]:</span>
                <span class="n">sample_id</span> <span class="o">=</span> <span class="n">samples_id_mapping</span><span class="p">[</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span>
                <span class="n">default_values</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>
                <span class="n">sample_value</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">variant_id</span><span class="p">]</span>
                <span class="n">sample_value</span> <span class="o">+=</span> <span class="p">[</span><span class="n">default_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sample_columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
                <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample_value</span><span class="p">)</span>

            <span class="n">placeholders</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;?&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_columns</span><span class="p">))</span>

            <span class="n">q</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;INSERT INTO sample_has_variant VALUES (</span><span class="si">{placeholders}</span><span class="s2">)&quot;</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>

        <span class="c1"># Yield progression</span>
        <span class="k">if</span> <span class="n">variant_count</span> <span class="o">%</span> <span class="n">yield_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">total_variant_count</span><span class="p">:</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="n">variant_count</span> <span class="o">/</span> <span class="n">total_variant_count</span> <span class="o">*</span> <span class="mi">100</span>

            <span class="k">yield</span> <span class="n">progress</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{variant_count}</span><span class="s2"> variants inserted.&quot;</span>

    <span class="c1"># Commit the transaction</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">yield</span> <span class="mi">97</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;{variant_count - errors} variant(s) has been inserted.&quot;</span>

    <span class="c1"># Create default selection (we need the number of variants for this)</span>
    <span class="n">insert_selection</span><span class="p">(</span>
        <span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">DEFAULT_SELECTION_NAME</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">variant_count</span> <span class="o">-</span> <span class="n">errors</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="insert_many_variants"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.insert_many_variants">[docs]</a><span class="k">def</span> <span class="nf">insert_many_variants</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper for debugging purpose&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">async_insert_many_variants</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span></div>


<span class="c1">## samples table ===============================================================</span>


<div class="viewcode-block" id="create_table_samples"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.create_table_samples">[docs]</a><span class="k">def</span> <span class="nf">create_table_samples</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create samples table</span>

<span class="sd">    :param conn: sqlite3.connect</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="c1"># sample_id is an alias on internal autoincremented &#39;rowid&#39;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;CREATE TABLE samples (</span>
<span class="sd">        id INTEGER PRIMARY KEY ASC,</span>
<span class="sd">        name TEXT,</span>
<span class="sd">        family_id TEXT DEFAULT &#39;fam&#39;,</span>
<span class="sd">        father_id INTEGER DEFAULT 0,</span>
<span class="sd">        mother_id INTEGER DEFAULT 0,</span>
<span class="sd">        sex INTEGER DEFAULT 0,</span>
<span class="sd">        phenotype INTEGER DEFAULT 0</span>
<span class="sd">        )&quot;&quot;&quot;</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

    <span class="n">schema</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">f</span><span class="s1">&#39;`</span><span class="si">{field[&quot;name&quot;]}</span><span class="s1">` </span><span class="si">{field[&quot;type&quot;]}</span><span class="s1"> {field.get(&quot;constraint&quot;, &quot;&quot;)}&#39;</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span>
            <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="s2">&quot;gt INTEGER DEFAULT -1&quot;</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">f</span><span class="s2">&quot;&quot;&quot;CREATE TABLE sample_has_variant  (</span>
<span class="s2">        sample_id INTEGER NOT NULL,</span>
<span class="s2">        variant_id INTEGER NOT NULL,</span>
<span class="s2">        </span><span class="si">{schema}</span><span class="s2">,</span>
<span class="s2">        PRIMARY KEY (sample_id, variant_id),</span>
<span class="s2">        FOREIGN KEY (sample_id) REFERENCES samples (id)</span>
<span class="s2">          ON DELETE CASCADE</span>
<span class="s2">          ON UPDATE NO ACTION</span>
<span class="s2">        ) WITHOUT ROWID</span>
<span class="s2">       &quot;&quot;&quot;</span>
    <span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="insert_sample"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.insert_sample">[docs]</a><span class="k">def</span> <span class="nf">insert_sample</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;no_name&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Insert one sample in samples table (USED in TESTS)</span>

<span class="sd">    :param conn: sqlite3.connect</span>
<span class="sd">    :return: Last row id</span>
<span class="sd">    :rtype: &lt;int&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO samples (name) VALUES (?)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">name</span><span class="p">])</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span></div>


<div class="viewcode-block" id="insert_many_samples"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.insert_many_samples">[docs]</a><span class="k">def</span> <span class="nf">insert_many_samples</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">samples</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Insert many samples at a time in samples table</span>

<span class="sd">    :param samples: List of samples names</span>
<span class="sd">        .. todo:: only names in this list ?</span>
<span class="sd">    :type samples: &lt;list &lt;str&gt;&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
        <span class="s2">&quot;INSERT INTO samples (name) VALUES (?)&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">sample</span><span class="p">,)</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_samples"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_samples">[docs]</a><span class="k">def</span> <span class="nf">get_samples</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get samples from sample table</span>

<span class="sd">    See Also: :meth:`update_sample`</span>

<span class="sd">    :param conn: sqlite3.conn</span>
<span class="sd">    :return: Generator of dictionnaries with as sample fields as values.</span>
<span class="sd">        :Example: ({&#39;id&#39;: &lt;unique_id&gt;, &#39;name&#39;: &lt;sample_name&gt;})</span>
<span class="sd">    :rtype: &lt;generator &lt;dict&gt;&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM samples&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_sample_annotations"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.get_sample_annotations">[docs]</a><span class="k">def</span> <span class="nf">get_sample_annotations</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">variant_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get samples for given sample id and variant id&quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">f</span><span class="s2">&quot;SELECT * FROM sample_has_variant WHERE variant_id = </span><span class="si">{variant_id}</span><span class="s2"> and sample_id = </span><span class="si">{sample_id}</span><span class="s2">&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_sample"><a class="viewcode-back" href="../../../queries.html#cutevariant.core.sql.update_sample">[docs]</a><span class="k">def</span> <span class="nf">update_sample</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">sample</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update sample record</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        sample = {</span>
<span class="sd">            id : 3 #sample id</span>
<span class="sd">            name : &quot;Boby&quot;,  #Name of sample</span>
<span class="sd">            family_id : &quot;fam&quot;, # familly identifier</span>
<span class="sd">            father_id : 0, #father id, 0 if not</span>
<span class="sd">            mother_id : 0, #mother id, 0 if not</span>
<span class="sd">            sex : 0 #sex code ( 1 = male, 2 = female, 0 = unknown)</span>
<span class="sd">            phenotype: 0 #( 1 = control , 2 = case, 0 = unknown)</span>
<span class="sd">        }</span>

<span class="sd">    Args:</span>
<span class="sd">        conn (sqlite.connection): sqlite connection</span>
<span class="sd">        sample (dict): data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;sample id is required&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">sql_set</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sql_val</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sample</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span>
            <span class="n">sql_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;`</span><span class="si">{key}</span><span class="s2">` = ? &quot;</span><span class="p">)</span>
            <span class="n">sql_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;UPDATE samples SET &quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sql_set</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; WHERE id = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">sql_val</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2020, labsquare.org.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>